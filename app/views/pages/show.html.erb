<% document_title @document.title -%>
<% page_title @page.title -%>

<%= include_stylesheets :page_viewer, :media => 'all' %>

<div class="content">
  <div id="static_page_content" class="wrap" style="width:<%= @page.data['css']['width'] %>; height: <%= @page.data['css']['height'] %>;background-color: white;position: relative;">
    <div class="loading-icon"></div>
  </div>
</div>

<% content_for :scripts do %>
  <%= include_javascripts :page_editor %>
  <%= include_javascripts :static_page %>

  <% if !Rails.env.production? %>
    <%= javascript_include_tag APP_CONFIG['shindig_server_base'] + "/js/core:rpc:pubsub:shindig-container.js?c=1&debug=1" %>
  <% end %>

  <% javascript_tag do -%>
    WebDoc.Application.main(function() {
      var staticPage = new WebDoc.StaticPage('<%= @document.uuid %>', '<%= @page.uuid %>', '<%= params[:secure_token] %>');
      staticPage.start();
    });
    
    <% cached_document = Rails.cache.fetch("#{@document.cache_key}_wo_script") { @document.to_json(:include => { :pages => { :include => :items} }).gsub(/<\/script>/, "</*script>") } %>
    try {
      WebDoc.ServerManager.cache.store(new WebDoc.Document(<%= raw cached_document.dup %>));
    }
    catch(e) {
      ddd("error in doc ", e);
    }

  <% end -%>
<% end %>

