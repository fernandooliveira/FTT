function DescendantTreeProfileEdit(parent){
	var self = this;
	this.parent = parent;
	this.div = null;
}

DescendantTreeProfileEdit.prototype = {
	_ajax:function(func, params, callback){
		host.callMethod("descendant_tree", "DescendantTree", func, params, function(res){
				callback(res);
		})
	},
	createDiv:function(){
		var html = '<div class="jmb-dtpe-container">';
			html += '<table>';
				html += '<tr>';
					html += '<td valign="top">';
						html += '<div class="jmb-dtpe-header">';
							html += '<div class="jmb-dtpe-header-name">&nbsp;</div>';
							html += '<div class="jmb-dtpe-header-avatar">&nbsp;</div>';
							html += '<div class="jmb-dtpe-header-close-button">Close</div>';
						html += '</div>';
					html += '</td>';
					html += '<td valign="top">';
						html += '<div class="jmb-dtpe-body">&nbsp;</div>';
					html += '</td>';
				html += '</tr>';
			html += '</table>';
		html += '</div>';
		return jQuery(html);
	},
	getDateEdit:function(){
		var html = '<input name="Date" type="text" class="active" style="width:80px;" readonly> in <input name="Place" type="text" style="width:150px;" class="active"><input type="submit" value="ok">';
		return html;
	},
	createTabs:function(){
		var self = this;
		var html = '<div class="jmb-dtpe-tabs">';
			html += '<table width="100%">';
				html += '<tr><td><table><tr>';
					html += '<td><div type="details" class="jmb-dtpe-tabs-item active">Details</div></td>';
					html += '<td><div type="media" class="jmb-dtpe-tabs-item">Media</div></td>';
					html += '<td><div type="add" class="jmb-dtpe-tabs-item">Add Relative</div></td>';
					html += '<td><div class="jmb-dtpe-tabs-delete">&nbsp;</div></td>';
				html += '</tr></table></td></tr>';
				html += '<tr><td><div class="jmb-dtpe-tabs-body">';
					html += '<div type="details" class="jmb-dtpe-tabs-container">';
						html += '<fieldset>';
							html += '<legend>Basic Info</legend>';
							html += '<table>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-item-name"><span>First Name:</span></div></td>';
									html += '<td><div name="FirstName" class="jmb-dtpe-tabs-item-node"><div class="jmb-dtpe-tabs-item-text">&nbsp;</div><div style="display:none;" class="jmb-dtpe-tabs-item-edit"><input type="text" class="active"></div></div></td>';
								html += '</tr>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-item-name"><span>Last Name:</span></div></td>';
									html += '<td><div name="LastName" class="jmb-dtpe-tabs-item-node"><div class="jmb-dtpe-tabs-item-text">&nbsp;</div><div style="display:none;" class="jmb-dtpe-tabs-item-edit"><input type="text" class="active"></div></div></td>';
								html += '</tr>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-item-name"><span>Gender:</span></div></td>';
									html += '<td><span class="jmb-dtpe-tabs-item-radio">Male: <input name="Gender" type="radio" value="M"></span> <span class="jmb-dtpe-tabs-item-radio">Female: <input name="Gender" type="radio" value="F"></span></td>';
								html += '</tr>';
							html += '</table>'; 
						html += '</fieldset>';
						html += '<fieldset>';
							html += '<legend>Events</legend>';
							html += '<table>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-item-name"><span>Birth:</span></div></td>';
									html += '<td><div name="Birth" class="jmb-dtpe-tabs-item-node"><div class="jmb-dtpe-tabs-item-text">&nbsp;</div><div style="display:none;" class="jmb-dtpe-tabs-item-edit">'+self.getDateEdit()+'</div></div></td>';
								html += '</tr>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-item-name"><span>Death:</span></div></td>';
									html += '<td><div name="Death" class="jmb-dtpe-tabs-item-node"><div class="jmb-dtpe-tabs-item-text">&nbsp;</div><div style="display:none;" class="jmb-dtpe-tabs-item-edit">'+self.getDateEdit()+'</div></div></td>';
								html += '</tr>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-item-name"><span>Married:</span></div></td>';
									html += '<td><div name="Married" class="jmb-dtpe-tabs-item-node"><div class="jmb-dtpe-tabs-item-text">&nbsp;</div><div style="display:none;" class="jmb-dtpe-tabs-item-edit">'+self.getDateEdit()+'</div></div></td>';
								html += '</tr>';
							html += '</table>';
						html += '</fieldset>';
						html += '<fieldset>';
							html += '<legend>Description</legend>';
							html += '<div name="Description" style="width:475px;margin-left:20px;" class="jmb-dtpe-tabs-item-node"><div class="jmb-dtpe-tabs-item-text" style="line-height:14px;"></div><div style="display:none;" class="jmb-dtpe-tabs-item-edit"><table><tr></td><textarea></textarea></td><td><input type="submit" value="ok"></td></tr></table></div></div>';
						html += '</fieldset>';
						html += '<fieldset>';
							html += '<legend>Sources</legend>';
							html += '<div name="Sources" style="width:475px;margin-left:20px;"></div>';
						html += '</fieldset>';
					html += '</div>';
					html += '<div type="media" class="jmb-dtpe-tabs-container">&nbsp;</div>';
					html += '<div type="add" class="jmb-dtpe-tabs-container">';
						html += '<fieldset>';
							html += '<legend>Information</legend>';
							html += '<table>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-item-name"><span>First Name:</span></div></td>';
									html += '<td><input name="FirstName" type="text" class="active"></td>';
								html += '</tr>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-item-name"><span>Last Name:</span></div></td>';
									html += '<td><input name="LastName" type="text" class="active"></td>';
								html += '</tr>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-item-name"><span>Gender:</span></div></td>';
									html += '<td><span class="jmb-dtpe-tabs-item-radio">Male: <input name="Sex" type="radio" value="M" checked></span> <span class="jmb-dtpe-tabs-item-radio">Female: <input name="Sex" type="radio" value="F"></span></td>';
								html += '</tr>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-item-name"><span>Type:</span></div></td>';
									html += '<td><select><option value="parent">Parent</option><option value="spouse">Spouse</option><option value="child">Child</option></select></td>';
								html += '</tr>';
								html += '<tr>';
									html += '<td><div class="jmb-dtpe-tabs-button">Save</div></td>';
								html += '</tr>';
							html += '</table>';
						html += '</fieldset>';
					html += '</div>';
				html += '</div></td></tr>';
			html += '</table>';
		html += '</div>';
		var obj = jQuery(html);
		var body = jQuery(obj).find('.jmb-dtpe-tabs-body');
		jQuery(body).find('div[type="media"]').hide();
		jQuery(body).find('div[type="add"]').hide();
		return obj;
	},
	setTabsEvent:function(tabs){
		var self = this;
		jQuery(tabs).find('.jmb-dtpe-tabs-item').each(function(index, element){
			if(jQuery(element).hasClass('active')){ tabs.activeButton = element; }
			jQuery(element).click(function(){
				jQuery(tabs.activeButton).removeClass('active');
				jQuery(this).addClass('active');
				tabs.activeButton = this;
				
				var body = jQuery(tabs).find(".jmb-dtpe-tabs-body");
				jQuery(body).find('.jmb-dtpe-tabs-container').each(function(idnex, element){
					jQuery(element).hide();
				});
				jQuery(body).find('div[type="'+jQuery(this).attr('type')+'"]').show();
			});
		});
		var body = jQuery(tabs).find('.jmb-dtpe-tabs-body');		
		//add tab
		jQuery(body).find('div[type="add"]').find('.jmb-dtpe-tabs-button').click(function(){
			var fistName,lastName,gender,type;
			firstName = jQuery(body).find('div[type="add"]').find('input[name="FirstName"]').val();
			lastName = jQuery(body).find('div[type="add"]').find('input[name="LastName"]').val();
			gender = jQuery(body).find('div[type="add"]').find('input:radio[name="Sex"]:checked').val();
			type = jQuery(body).find('div[type="add"]').find('select').val();
			var request = '{"ownerID":"'+self.parent.profile.json.ind.Id+'","FirstName":"'+firstName+'","LastName":"'+lastName+'","Gender":"'+gender+'","Type":"'+type+'"}';
			self._ajax('addRelative', request, function(res){});
		});
	
		//radio input
		jQuery(body).find('span.jmb-dtpe-tabs-item-radio').each(function(index,element){
			jQuery(element).click(function(){
				var input = jQuery(this).find('input');
				jQuery(input).attr('checked', 'checked');
				if(jQuery(input).attr('name') == 'Gender'){
					var val = jQuery(input).val();
					var request = '{"request":{"Gender":"'+val+'"},"ownerId":"'+self.parent.profile.json.ind.Id+'"}';
					self._ajax('change', request, function(res){});
				}
			});
		});
		
		//edit item
		jQuery(body).find('.jmb-dtpe-tabs-item-text').each(function(index,element){
			jQuery(element).click(function(){
				var type = jQuery(element).parent().attr('name');
				switch(type){
					case "FirstName":
					case "LastName":
						self.setHandleName(element);
					break;
					
					case "Birth":
					case "Death":
					case "Married":
						self.setHandleEvent(element, type);
					break;	
					
					case "Description":
						self.setHandleDescription(element);
					break;
				}
			});
		})
	},
	setHandleName:function(element){
		var self = this;
		var value = jQuery(element).html();
		var edit = jQuery(element).parent().find('.jmb-dtpe-tabs-item-edit');
		var input = jQuery(edit).find('input');
		jQuery(input).val(value);
		jQuery(element).hide();
		jQuery(edit).show();
		jQuery(input).focus();
		jQuery(input).focusout(function(){
			var val = jQuery(this).val();
			jQuery(element).text(val);
			jQuery(edit).hide();
			jQuery(element).show();
		});
		jQuery(input).change(function(){
			var val = jQuery(this).val();
			var opt = jQuery(element).parent().attr('name');
			var request = '{"request":{"'+opt+'":"'+val+'"},"ownerId":"'+self.parent.profile.json.ind.Id+'"}';
			self._ajax('change', request, function(res){});
		});
	},
	setHandleEvent:function(element, type){
		var self = this;
		var value = jQuery(element).html();
		var edit = jQuery(element).parent().find('.jmb-dtpe-tabs-item-edit');
		var date = (value.split(' ')[0] != 'edit')? value.split(' ')[0] : '';
		if(date == '&nbsp;') date = '';
		var place = (value.split(' ')[2])? value.split(' ')[2] : '';
		jQuery(edit).find('input[name="Date"]').val(date);
		jQuery(edit).find('input[name="Place"]').val(place);
		jQuery(element).hide();
		jQuery(edit).show();
		jQuery(edit).find('input[name="Date"]').datepick({
			dateFormat:"d-M-yyyy",
			changeYear:true,
			yearRange: 'any'
		});
		jQuery(edit).find('input[type="submit"]').click(function(){
			var date = jQuery(edit).find('input[name="Date"]').val();
			var place = jQuery(edit).find('input[name="Place"]').val(); 
			var request = '{"request":{"date":"'+date+'","place":"'+place+'","type":"'+type+'"},"ownerId":"'+self.parent.profile.json.ind.Id+'"}'
			if(date != '' || place != ''){
				self._ajax('changeEvent', request, function(res){
					jQuery(element).text(date+' in '+place);
					jQuery(edit).hide();
					jQuery(element).show();
				});
			}
			else {
				jQuery(edit).hide();
				jQuery(element).show();
			}
		});
	},
	setHandleDescription:function(element){
		var self = this;
		var value = jQuery(element).html();
		value = (value == '&nbsp;')?'':value;
		var edit  = jQuery(element).parent().find('.jmb-dtpe-tabs-item-edit');
		var textarea = jQuery(edit).find('textarea');
		jQuery(textarea).val(value);
		jQuery(element).hide();
		jQuery(edit).show();
		jQuery(edit).find('input[type="submit"]').click(function(){
			var text = jQuery(textarea).val();
			var request = '{"ownerId":"'+self.parent.profile.json.ind.Id+'","request":{"text":"'+text+'"}}';
			jQuery(element).text(text);	
			self._ajax('description', request,function(res){
				jQuery(edit).hide();
				jQuery(element).show();
			});
		});
	},
	setHandleSources:function(element, flag){
		var self = this;
		var edit
		if(flag){
			var tr = jQuery(self.addSourceRow({Title:'Title',Id:'null',Author:'null',Publication:''}));
			jQuery(element).parent().parent().before(tr);
			edit = jQuery(tr).find('.jmb-dtpe-tabs-item-source-edit');
			element = jQuery(tr).find('.jmb-dtpe-tabs-item-source');
			jQuery(tr).find('.jmb-dtpe-tabs-item-source').click(function(){
				self.setHandleSources(this, false);
			});
		}
		else{
			edit = jQuery(element).parent().find('.jmb-dtpe-tabs-item-source-edit');
		}
		var title = jQuery(element).parent().find('legend').html();
		var value = jQuery(element).html();
		var id = jQuery(element).attr('Id');
		jQuery(edit).find('input[type="text"]').val(title);
		jQuery(edit).find('textarea').val(value);
		jQuery(element).hide();
		jQuery(edit).show();
		jQuery(edit).find('input[type="submit"]').click(function(){
			title = jQuery(edit).find('input[type="text"]').val()
			value = jQuery(edit).find('textarea').val();
			var request = '{"ownerId":"'+self.parent.profile.json.ind.Id+'","request":{"Id":"'+id+'","Title":"'+title+'","Publication":"'+value+'"}}';
			self._ajax('sources', request, function(res){
					jQuery(element).parent().find('legend').text(title);
					jQuery(element).text(value);
					jQuery(edit).hide();
					jQuery(element).show();
			})
		});	
	},
	getBirth:function(ind){
		if(ind.Birth){
			var b = ind.Birth;
			var place = this.parent.profile.getPlace(b.Place.Hierarchy);
			var date = this.parent.profile.getDate(b);
			return date + ((place)?' in '+place.Name :'');	
		}
		else {
			return 'edit';
		}
	},
	getDeath:function(ind){
		if(ind.Death){
			var d = ind.Death;
			var place = this.parent.profile.getPlace(d.Place.Hierarchy);
			var date = this.parent.profile.getDate(d);
			return date + ((place)?' in '+place.Name :'');
		}
		else {
			return 'edit';
		}
	},
	getMarried:function(){
		var fam = this.parent.profile.json.fam;
		if(fam == null) return 'edit';
		if(fam.Marriage){
			var marr = fam.Marriage;
			var date = this.parent.profile.getDate(marr);
			var place = this.parent.profile.getPlace(marr.Place.Hierarchy);
			return date + ((place)?' in '+place.Name :'');
		}
		else{
			return 'edit';
		}
	},
	getDescription:function(){
		var notes = this.parent.profile.json.notes;
		if(notes.length > 0){
			return notes[0].Text;
		}
		else{
			return 'edit';
		}
	},
	addSourceRow:function(e){
		return '<tr><td><fieldset><legend>'+e.Title+'</legend><div id="'+e.Id+'" author="'+e.Author+'" class="jmb-dtpe-tabs-item-source">'+((e.Publication)?e.Publication:'edit')+'</div><div class="jmb-dtpe-tabs-item-source-edit" style="display:none;"><table><tr><td>Title: <input type="text" class="active"></td></tr><tr><td><textarea></textarea></td></tr><tr><td><input type="submit" value="Ok"></td></tr></table></div></fieldset></td></tr>';
	},
	getSources:function(){
		var self = this;
		var sources = this.parent.profile.json.sources;	
		var table = jQuery('<table></table>');
		jQuery(sources).each(function(i,e){
			jQuery(table).append(self.addSourceRow(e));
		})
		jQuery(table).append('<tr><td align="center"><div class="jmb-dtpe-tabs-item-source-add">Add</div></td></tr>');
		return jQuery(table).html();		
	},
	setInfo:function(tabs){
		var self = this;
		var ind = this.parent.profile.json.ind;
		//basic info
		var details = jQuery(tabs).find('div[type="details"]')
		jQuery(details).find('div[name="FirstName"]').find('.jmb-dtpe-tabs-item-text').html(ind.FirstName);
		jQuery(details).find('div[name="LastName"]').find('.jmb-dtpe-tabs-item-text').html(ind.LastName);
		jQuery(details).find('input[name="Gender"][value="'+ind.Gender+'"]').attr('checked', 'checked');
		jQuery(details).find('div[name="Birth"]').find('.jmb-dtpe-tabs-item-text').html(this.getBirth(ind));
		jQuery(details).find('div[name="Death"]').find('.jmb-dtpe-tabs-item-text').html(this.getDeath(ind));
		jQuery(details).find('div[name="Married"]').find('.jmb-dtpe-tabs-item-text').html(this.getMarried());
		jQuery(details).find('div[name="Description"]').find('.jmb-dtpe-tabs-item-text').html(this.getDescription());
		jQuery(details).find('div[name="Sources"]').html(this.getSources());
		
		//events sources
		jQuery(details).find('.jmb-dtpe-tabs-item-source').each(function(index, element){
			jQuery(element).click(function(){
				self.setHandleSources(element, false);
			});
		});
		jQuery(details).find('.jmb-dtpe-tabs-item-source-add').click(function(){
			self.setHandleSources(this, true);
		});
	},
	getName:function(){
		var ind = this.parent.profile.json.ind;
		return ind.FirstName+' '+ind.LastName;
	},
	getAvatar:function(){
		return '&nbsp;';
	},
	getBody:function(){
		var self = this;
		//create tabs
		var tabs = this.createTabs();
		this.setTabsEvent(tabs);
		this.setInfo(tabs);
		jQuery(tabs).find('.jmb-dtpe-tabs-delete').click(function(){
			if(confirm("Do you really want to delete this user?")){
				self._ajax('userDelete', '{"ownerId":"'+self.parent.profile.json.ind.Id+'"}', function(res){
					self.close(true);
				});
			}
		});
		return tabs;
	},
	close:function(del){
		var self = this;
		var div = this.div;
		jQuery(div).hide();
		jQuery(self.parent.obj).show();
		if(del){
			self.parent.profile.clear();
		}
		else {
			self.parent.profile.render(self.parent.profile.json.ind.Id);
		}
		var dhxTree = self.parent.dhxTree;
		dhxTree.deleteChildItems('0');
		dhxTree.deleteItem('0');
		self.parent.loadTree(dhxTree, jQuery(self.parent.profile.renderButton).attr('type'));	
	},
	render:function(){
		var self = this;
		var div = this.createDiv();
		var obj = this.parent.obj;
		var objParent = jQuery(obj).parent();
		jQuery(div).hide();
		jQuery(objParent).append(div);
		jQuery(div).find('.jmb-dtpe-header-name').html(self.getName());
		jQuery(div).find('.jmb-dtpe-header-avatar').html(self.getAvatar());
		jQuery(div).find('.jmb-dtpe-body').append(self.getBody());
		jQuery(div).find('.jmb-dtpe-header-close-button').click(function(){
			self.close(false);
		});
		jQuery(obj).hide();
		jQuery(div).show();
		this.div = div;
	}
}
